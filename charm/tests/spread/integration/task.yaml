summary: Run the charm integration test

prepare: |
  pushd "$SPREAD_PATH"

  if [[ ! -f "$PWD/openapi-rest-proxy_amd64.charm" ]]; then
    echo "Packing charm"
    charmcraft pack --verbose
  else
    echo "Skipping charmcraft pack, charm already exists" 
  fi

execute: |
  # oci_image="$(cat ../../charmcraft.yaml | yq '.resources.proxy-image.upstream-source')"
  echo "Executing at"
  echo $PWD

  echo "PWD"
  echo $(ls -l $PWD)

  echo "PWD/.."
  echo $(ls -l ../)

  echo "PWD/../.."
  echo $(ls -l ../../)

  oci_image="ghcr.io/canonical/openapi-rest-proxy:latest"
  juju deploy "$PWD/openapi-rest-proxy_amd64.charm" proxy --resource proxy-image="${oci_image}"

  juju wait-for application proxy

restore: |
  if [[ -z "${CI:-}" ]]; then
    juju destroy-model --no-prompt --destroy-storage testing
    juju add-model testing
  fi
